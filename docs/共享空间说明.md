# 共享空间说明文档

本文档说明 WeKnora 中的**共享空间**功能，包括空间创建与加入、成员角色与权限、知识库与智能体共享规则、智能体停用机制，以及用户对知识库的最终访问权限计算方式。

---

## 一、共享空间概述

### 1.1 什么是共享空间

共享空间是跨租户协作的载体。用户可以在同一系统内属于不同租户（账户），通过**加入同一共享空间**，实现：

- 共享知识库：将本租户的知识库共享到空间，供空间内其他成员使用；
- 共享智能体：将本租户的智能体共享到空间，供空间内其他成员在对话等场景中使用；
- 访问他人共享的知识库：在「知识库列表」中看到并打开通过空间共享给自己的知识库；
- 在对话、智能体等场景中选择并使用这些共享知识库与共享智能体。

数据与权限关系简要如下：

- **租户**：知识库、智能体的归属单位，每个知识库/智能体属于一个租户；
- **共享空间**：不拥有知识库或智能体，只记录「某知识库/智能体被共享到某空间」以及「共享时的权限」；
- **成员**：用户通过邀请码或管理员邀请加入空间，在空间内拥有一个角色（管理员 / 编辑者 / 只读）。

### 1.2 核心概念对照

| 概念 | 说明 |
|------|------|
| 共享空间 | 系统中的「组织」（Organization），用于跨租户共享知识库与智能体 |
| 空间创建者 | 创建该空间的用户，自动成为该空间的管理员，且不可被移除或降级 |
| 空间成员 | 通过邀请码加入或由管理员邀请加入的用户，拥有管理员、编辑者或只读之一角色 |
| 知识库/智能体归属 | 知识库、智能体始终属于一个租户；共享到空间不改变归属，只建立「空间 ↔ 知识库/智能体」的共享关系 |
| 共享关系 | 一条记录表示：某知识库以某种权限（只读/可写）被共享到某共享空间；或某智能体以只读方式被共享到某共享空间 |

---

## 二、共享空间的创建、加入与离开

### 2.1 创建空间

- 任意已登录用户均可创建空间。
- 创建时需填写空间名称；描述、头像、邀请码有效期等为可选项。
- 创建者自动成为该空间的**管理员**，且：
  - 不能将自己移出空间；
  - 不能将自己的角色改为编辑者或只读。

### 2.2 加入空间

加入方式有两种：

1. **邀请码直接加入**
   - 若空间未开启「加入需审批」，用户输入有效邀请码即可加入。
   - 加入后默认角色为**只读**。
2. **提交加入申请（需审批）**
   - 若空间开启了「加入需审批」，用户输入邀请码后提交加入申请。
   - 空间管理员审批通过时可指定角色（管理员/编辑者/只读）；若不指定，则使用申请时填写的角色或默认只读。
   - 审批拒绝后，用户不是成员，无法访问该空间及其共享知识库。

### 2.3 成员人数上限

- 空间可设置**成员人数上限**（默认 200；设为 0 表示不限制）。
- 达到或超过上限时：
  - 邀请码加入、管理员添加成员、审批通过加入均会被拒绝，并提示「该空间成员已满」；
  - 已满时不允许提交新的加入申请。
- 管理员在设置中调低上限时，若当前成员数已超过新上限，不允许保存，需先移除成员或设置更大的上限。

### 2.4 邀请码

- 仅空间**管理员**可生成或刷新邀请码。
- 邀请码可设置有效期（例如 1 天、7 天、30 天或永不过期）；过期后需重新生成才能使用。
- 同一时间一个空间仅有一个有效邀请码；重新生成会使旧邀请码失效。

### 2.5 离开空间

- 成员可主动退出空间（无需管理员同意）。
- 管理员可移除其他成员（不能移除空间创建者）。
- 退出或移除后，该用户不再拥有该空间内的任何角色，也无法再通过该空间访问其共享的知识库。

### 2.6 删除空间

- 仅空间**创建者**可删除空间。
- 删除空间时会解除该空间下所有知识库的共享关系，成员将无法再通过该空间访问这些知识库。

---

## 三、空间内角色与权限

共享空间内共有三种角色，权限从高到低为：**管理员 > 编辑者 > 只读**。

### 3.1 角色定义

| 角色 | 英文标识 | 说明 |
|------|----------|------|
| 管理员 | admin | 空间设置、成员、邀请码及知识库共享的全面管理 |
| 编辑者 | editor | 可编辑空间内共享的知识库内容，可将自己的知识库共享到空间；不可管理空间设置与成员 |
| 只读 | viewer | 仅可查看与检索空间内共享的知识库；不可共享知识库到空间，不可管理空间 |

### 3.2 权限矩阵（空间内能力）

| 能力 | 管理员 | 编辑者 | 只读 |
|------|--------|--------|------|
| 查看、检索空间内共享的知识库 | ✓ | ✓ | ✓ |
| 编辑空间内共享的知识库内容 | ✓ | ✓ | ✗ |
| **将知识库共享到本空间** | ✓ | ✓ | ✗ |
| 管理空间内知识库共享（取消共享、修改共享权限等） | ✓（见下） | 仅限自己发起的共享 | ✗ |
| 管理空间设置（名称、描述、头像、邀请码有效期、是否需审批等） | ✓ | ✗ | ✗ |
| 管理成员（邀请、移除、修改角色） | ✓ | ✗ | ✗ |
| 生成/刷新邀请码 | ✓ | ✗ | ✗ |
| 审批加入申请、权限升级申请 | ✓ | ✗ | ✗ |
| 提交权限升级申请 | — | ✓ | ✓ |
| 退出空间 | ✓ | ✓ | ✓ |

说明：

- **「将知识库共享到本空间」**：仅**管理员**和**编辑者**可以执行；只读成员不能把自己的知识库共享到该空间。
- **管理空间内知识库共享**：
  - 共享的发起人可取消自己发起的共享、修改该条共享的权限；
  - 空间**管理员**可取消任意一条指向本空间的共享（例如内容治理、发起人已离开等）。

---

## 四、知识库共享规则

### 4.1 谁可以发起共享

- 只有**知识库所属租户下的用户**（即「拥有」该知识库的账户下的用户）才能将该知识库共享到某个共享空间。
- 同时，该用户必须是目标共享空间的**成员**，且角色为**管理员**或**编辑者**。  
  即：**只读成员不能把任何知识库（包括自己的）共享到该空间。**

### 4.2 共享时的权限设置

将知识库共享到空间时，需为「该空间」指定一个**共享权限**：

- **只读（viewer）**：空间成员在该知识库上最多只读（实际权限还会受成员在空间内的角色限制，见下）。
- **可写（editor）**：空间成员在该知识库上可被赋予编辑能力（同样受成员角色限制）。

同一知识库可以共享到多个共享空间，且每个空间可以设置不同的共享权限（例如空间 A 只读、空间 B 可写）。

### 4.3 更新与取消共享

- **修改某条共享的权限**：仅**发起该次共享的用户**可以修改（只读 ↔ 可写）。
- **取消某条共享**：
  - **发起该次共享的用户**可随时取消；
  - 目标空间的**管理员**也可取消该空间下的任意共享（包括他人发起的）。

### 4.4 同一知识库共享到多个空间

- 允许将同一知识库共享到多个共享空间。
- 每个空间一条共享记录，各自独立配置权限（只读/可写）。
- 例如：知识库 K 共享到空间 A（只读）、空间 B（可写），互不影响。

---

## 五、智能体共享规则

智能体也可通过共享空间在成员间共享，供成员在对话等场景中选择使用。规则与知识库共享类似，但权限仅支持只读。

### 5.1 谁可以发起智能体共享

- 只有**智能体所属租户下的用户**才能将该智能体共享到某个共享空间。
- 同时，该用户必须是目标共享空间的**成员**，且角色为**管理员**或**编辑者**（与知识库共享一致）。
- 智能体须已配置完成（如已选模型、若使用知识库则已选 rerank 模型等）方可共享。

### 5.2 共享时的权限

- 智能体共享到空间时**仅支持只读**：空间成员只能以「使用」方式使用该智能体（如在对话中选择），不能编辑该智能体的配置或删除共享关系以外的管理操作。
- 同一智能体可以共享到多个共享空间。

### 5.3 更新与取消共享

- **取消某条智能体共享**：
  - **发起该次共享的用户**可随时取消；
  - 目标空间的**管理员**也可取消该空间下的任意智能体共享（包括他人发起的）。

---

## 六、智能体停用机制

「停用」是当前租户对**通过共享空间获得的智能体**的一种个人偏好设置，仅影响本租户在**对话中选择智能体**时的展示与使用体验，不改变共享关系，也不影响其他成员。

### 6.1 停用的含义

- 当某租户将某个「通过共享空间获得的智能体」标记为**已停用**时：
  - 在该租户的对话界面中，该智能体可在下拉列表中被隐藏或标记为已停用，减少干扰；
  - 该智能体仍对该共享空间的其他成员可见、可用；
  - 共享关系不变，发起共享的用户与空间管理员仍可照常管理该条共享。
- 停用状态按「租户 + 智能体（含来源租户）」记录，即：同一智能体被多个空间共享时，用户停用后在所有入口对该智能体的展示偏好一致。

### 6.2 停用与恢复

- 用户可随时将已停用的共享智能体**恢复**，恢复后该智能体重新在对话下拉等列表中正常显示。
- 停用/恢复仅影响当前租户自己的视图与选择列表，不影响他人，也不影响该用户通过直接链接等方式访问该智能体。
